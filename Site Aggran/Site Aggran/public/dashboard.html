<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>DashBoard</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      
      <link rel="stylesheet" href="./css/style.css" />
   </head>
   <style>
      canvas {
         width: 80% !important;
         height: 280px !important;
         margin-bottom: 30px;
         justify-self: center;
      }
   </style>

   <body class="dashboard-body">

      <div class="sidebar">
         <div class="navbar">
            <a href="index.html"><img src="./Assets/logo_footer.png" alt="Logo_aggran"></a>
   
            <ul>
               <li><a href=""><span></span>Manual de Instalação</a></li>
               <li><a href="https://suporte-aggran-1763843210902.atlassian.net/servicedesk/customer/portal/2"><span></span>Suporte - Jira</a></li>
               <li><a onclick="AbrirBob()"><span></span>BobIA</a></li>
            </ul> 
         </div>

      </div>


      <div id="dash">
         <div class="ola" id="div_ola">
            Olá, Usuário.
         </div>
         <div class="kpis" id="div_kpis">
            <div class="kpi" id="H_abaixo">
                  <h1>Hectares abaixo do ideal:</h1>
                  <p id="p_KPI_Abaixo">3</p>
            </div>
            <div class="kpi" id="H_risco">
                  <h1>Hectares em risco/queda:</h1>
                  <p id="p_KPI_Risco">3</p>
            </div>
            <div class="kpi" id="H_estável">
                  <h1>Hectares estáveis:</h1>
                  <p id="p_KPI_Acima">4</p>
            </div>
         </div>

         <div class="sessão_dash">
            <div class="botoes_dash">
               <button class="button-hectar" onclick="HectarPrincipal()">H1</button><!-- Risco -->
               <button class="risco button-hectar" onclick="selecionarHectar(2, 20, 25)">H2</button><!-- Risco -->
               <button class="risco button-hectar" onclick="selecionarHectar(3, 22, 27)">H3</button><!-- Risco -->
               <button class="button-hectar" onclick="selecionarHectar(4, 30, 35)">H4</button><!-- Acima -->
               <button class="abaixo button-hectar" onclick="selecionarHectar(5, 10, 15)">H5</button><!-- Abaixo -->
               <button class="button-hectar" onclick="selecionarHectar(6, 40, 45)">H6</button><!-- Acima -->
               <button class="button-hectar" onclick="selecionarHectar(7, 32, 37)">H7</button><!-- Acima -->
               <button class="button-hectar" onclick="selecionarHectar(8, 43, 48)">H8</button><!-- Acima -->
               <button class="risco button-hectar" onclick="selecionarHectar(9, 22, 27)">H9</button><!-- Risco -->
               <button class="abaixo button-hectar" onclick="selecionarHectar(10, 14, 19)">H10</button><!-- Abaixo -->
            </div>
         </div>

         <div class="container_dash" id="grafico_h1" style="display: none">

            <canvas id="graficoHectar1"></canvas>
         </div>

         <div class="container_dash" id="grafico_sensor" style="display: none">
           
            <canvas id="graficoLinhaSensor"></canvas>
         </div>
      </div>

   </body>

   <script>
      var nomeUsuario = sessionStorage.NOME_USUARIO
      var umidade_h1
      div_ola.innerHTML = `Olá, ${nomeUsuario}`

      function AbrirBob() {
         window.open("http://localhost:3334")
      }
   

      var intervaloGeracaoDados = null; 
      var graficoLinhaSensor = null; 
      var dadosAtuais = []; 

      
      function selecionarHectar(idHectar, min, max) {
         
         if (intervaloGeracaoDados !== null) {
            clearInterval(intervaloGeracaoDados);
            console.log(`Intervalo anterior (ID: ${intervaloGeracaoDados}) parado.`);
         }

         
         document.getElementById('grafico_sensor').style.display = 'block';
         document.getElementById('grafico_h1').style.display = 'none';

   
         if (graficoLinhaSensor !== null) {
            graficoLinhaSensor.destroy();
         }

         dadosAtuais = [];

         graficoLinhaSensor = new Chart(document.getElementById("graficoLinhaSensor"), {
            type: "line",
            data: {
               labels: [],
               datasets: [{
                  label: `Umidade Hectar ${idHectar}`,
                  data: dadosAtuais,
                  borderColor: '#006838',
                  tension: 0.1
               }]
            },
            options: {
               scales: { y: { beginAtZero: false, min: min-5, max: max+5 } }
            }
         });


         
         intervaloGeracaoDados = setInterval(() => {
            gerarEAtualizarDados(min, max);
         }, 2000); 

         plotarGrafico()


         
         document.querySelectorAll('.button-hectar').forEach(btn => btn.classList.remove('active'));
         event.target.classList.add('active');
      }

      
      function gerarEAtualizarDados(min, max) {
         var novoRegistro = Number(Math.random() * (max - min + 1) + min).toFixed(2);
         
         
         if (dadosAtuais.length >= 10) {
            dadosAtuais.shift();
            graficoLinhaSensor.data.labels.shift();
         }
         
         dadosAtuais.push(novoRegistro); 
         graficoLinhaSensor.data.labels.push(new Date().toLocaleTimeString()); 

         
         graficoLinhaSensor.update();
         console.log(`Dados Hectar: ${dadosAtuais}`);
      }

      var lista_registro = []
function buscarUltimosRegistros() {
      fetch(`/registros/buscarUltimosRegistros`, { cache: "no-store" }  )
         .then(resultado => resultado.json())
         .then(resultado => {
            console.log("Entrei listar")
            umidade_h1 = resultado[0].umidadeSolo
            console.log(umidade_h1)
         })

         .catch(function (erro) {
            console.log('Erro frontend', erro);
         })
   }
var dadosglobal;
function listar() {
    var idusuario = sessionStorage.ID_USUARIO;
    fetch(`/registros/listar`, { cache: "no-store" })
        .then(response => response.json())
        .then(function (response) {
            console.log("pedro", response);

            
            lista_registro = []; 
            for (var i = 0; i < response.length; i++) {
                
                lista_registro.push(parseFloat(response[i].umidadeSolo));
            }

            
            plotarGrafico(lista_registro);

        })
        .catch(function (error) {
         
        });
    return false;
}


function plotarGrafico(listaDeUmidades) {

    let labels = [];
    
    for (let i = 0; i < listaDeUmidades.length; i++) {
        labels.push(`${i + 1}`);
    }

    let dados = {
        labels: labels,
        datasets: [{
            label: 'Umidade Hectar 1',
            data: listaDeUmidades, 
            borderColor: '#006838',
            fill: false,
            tension: 0.1
        }]
    };

    const config = {
        type: 'line',
        data: dados,
        options: {
            
        }
    };

    
    document.getElementById('grafico_h1').style.display = 'block';
    
    window.myChart = new Chart(
        document.getElementById(`graficoHectar1`),
        config
    );

    intervaloGraficoH1 = setInterval(() => {
        AtualizarGrafico(window.myChart);
    }, 2000); 
}


function AtualizarGrafico(g) {
    var idusuario = sessionStorage.ID_USUARIO;
    fetch(`/registros/listar`, { cache: "no-store" })
        .then(response => response.json())
        .then(function (response) {
            
            
            var novoValor;
            var novaLabel;

            if (response.length > 0) {
                const ultimoRegistro = response[response.length - 1]; 
                novoValor = parseFloat(ultimoRegistro.umidadeSolo);
                novaLabel = new Date().toLocaleTimeString(); 
            } else {
                 console.log("Nenhum registro recebido para atualizar.");
                 return;
            }

            if (g.data.datasets[0].data.length >= 10) {
                g.data.datasets[0].data.shift();
                g.data.labels.shift();
            }

            g.data.datasets[0].data.push(novoValor);
            g.data.labels.push(novaLabel);
            g.update();

        })
        .catch(function (error) {
            console.log(`Erro na obtenção dos dados p/ gráfico na atualização: ${error}`);
        });
}

function HectarPrincipal() {

document.getElementById('grafico_sensor').style.display = 'none';

document.getElementById('grafico_h1').style.display = 'block';

}
HectarPrincipal();
buscarUltimosRegistros();
listar();

      

   </script>
</html>