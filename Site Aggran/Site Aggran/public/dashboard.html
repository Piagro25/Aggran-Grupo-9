<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>DashBoard</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      
      <link rel="stylesheet" href="./css/style.css" />
   </head>
   <style>
      canvas {
         width: 80% !important;
         height: 280px !important;
         margin-bottom: 30px;
         justify-self: center;
      }
   </style>

   <body class="dashboard-body">

      <div class="sidebar">
         <div class="navbar">
            <a href="index.html"><img src="./Assets/logo_footer.png" alt="Logo_aggran"></a>
   
            <ul>
               <li><a href=""><span></span>Manual de Instalação</a></li>
               <li><a href="https://suporte-aggran-1763843210902.atlassian.net/servicedesk/customer/portal/2"><span></span>Suporte - Jira</a></li>
            </ul>
         </div>

      </div>


      <div id="dash">
         <div class="ola" id="div_ola">
            Olá, Usuário.
         </div>
         <div class="kpis" id="div_kpis">
            <div class="kpi" id="H_abaixo">
                  <h1>Hectares abaixo do ideal:</h1>
                  <p id="p_KPI_Abaixo">2</p>
            </div>
            <div class="kpi" id="H_risco">
                  <h1>Hectares em risco/queda:</h1>
                  <p id="p_KPI_Risco"></p>
            </div>
            <div class="kpi" id="H_estável">
                  <h1>Hectares estáveis:</h1>
                  <p id="p_KPI_Acima"></p>
            </div>
         </div>

         <div class="sessão_dash">
            <div class="botoes_dash">
               <button class="button-hectar" onclick="HectarPrincipal()">H1</button><!-- Risco -->
               <button class="risco button-hectar" onclick="selecionarHectar(2, 20, 25)">H2</button><!-- Risco -->
               <button class="risco button-hectar" onclick="selecionarHectar(3, 22, 27)">H3</button><!-- Risco -->
               <button class="button-hectar" onclick="selecionarHectar(4, 30, 35)">H4</button><!-- Acima -->
               <button class="abaixo button-hectar" onclick="selecionarHectar(5, 10, 15)">H5</button><!-- Abaixo -->
               <button class="button-hectar" onclick="selecionarHectar(6, 40, 45)">H6</button><!-- Acima -->
               <button class="button-hectar" onclick="selecionarHectar(7, 32, 37)">H7</button><!-- Acima -->
               <button class="button-hectar" onclick="selecionarHectar(8, 43, 48)">H8</button><!-- Acima -->
               <button class="risco button-hectar" onclick="selecionarHectar(9, 22, 27)">H9</button><!-- Risco -->
               <button class="abaixo button-hectar" onclick="selecionarHectar(10, 14, 19)">H10</button><!-- Abaixo -->
            </div>
         </div>

         <div class="container_dash" id="grafico_h1" style="display: none">
            <!-- Canvas específico para o gráfico de linha do sensor selecionado -->
            <canvas id="graficoHectar1"></canvas>
         </div>

         <div class="container_dash" id="grafico_sensor" style="display: none">
            <!-- Canvas específico para o gráfico de linha do sensor selecionado -->
            <canvas id="graficoLinhaSensor"></canvas>
         </div>
      </div>

   </body>

   <script>
      var nomeUsuario = sessionStorage.NOME_USUARIO
      div_ola.innerHTML = `Olá, ${nomeUsuario}`

      setInterval(ChecarKPI, 100)
      
      var KPI_Abaixo = 2;
      var KPI_Risco = 3;
      var KPI_Acima = 4;
      var h1 = 'verde'

      
      function ChecarKPI() {
         
         p_KPI_Abaixo.innerHTML = `${KPI_Abaixo}`
         p_KPI_Risco.innerHTML = `${KPI_Risco}`
         p_KPI_Acima.innerHTML = `${KPI_Acima}`

      if(h1 == 'verde') {
         var KPI_AcimaAux = KPI_Acima + 1;
         p_KPI_Acima.innerHTML = `${KPI_AcimaAux}`
      } else if(h1 == 'amarelo'){
         var KPI_RiscoAux = KPI_Risco + 1;
         p_KPI_Risco.innerHTML = `${KPI_RiscoAux}`
      }else {
         var KPI_AbaixoAux = KPI_Abaixo + 1;
         p_KPI_Abaixo.innerHTML = `${KPI_AbaixoAux}`
      }

      };



      // --- LÓGICA PARA GRÁFICOS DE SENSORES INDIVIDUAIS (LINHA) ---

      let intervaloGeracaoDados = null; // Variável para armazenar o ID do setInterval
      let graficoLinhaSensor = null; // Variável para a instância do novo gráfico de linha
      let dadosAtuais = []; // Array para armazenar os 10 últimos registros

      // Função principal chamada pelos botões H2 a H10
      function selecionarHectar(idHectar, min, max) {
         // 1. Parar qualquer intervalo anterior
         if (intervaloGeracaoDados !== null) {
            clearInterval(intervaloGeracaoDados);
            console.log(`Intervalo anterior (ID: ${intervaloGeracaoDados}) parado.`);
         }

         // 2. Mudar a visualização para o gráfico do sensor
         document.getElementById('grafico_sensor').style.display = 'block';
         document.getElementById('grafico_h1').style.display = 'none';

         // 3. Destruir gráfico de linha anterior se existir, e criar um novo
         if (graficoLinhaSensor !== null) {
            graficoLinhaSensor.destroy();
         }

         dadosAtuais = []; // Limpa os dados para o novo sensor

         graficoLinhaSensor = new Chart(document.getElementById("graficoLinhaSensor"), {
            type: "line",
            data: {
               labels: [], // Rótulos de tempo/index
               datasets: [{
                  label: `Umidade Hectar ${idHectar}`,
                  data: dadosAtuais,
                  borderColor: '#006838',
                  tension: 0.1
               }]
            },
            options: {
               scales: { y: { beginAtZero: false, min: min-5, max: max+5 } }
            }
         });


         // 4. Iniciar novo intervalo para o novo hectar selecionado
         intervaloGeracaoDados = setInterval(() => {
            gerarEAtualizarDados(min, max);
         }, 2000); // Gera um novo dado a cada 2 segundos
         
         document.querySelectorAll('.button-hectar').forEach(btn => btn.classList.remove('active'));
         event.target.classList.add('active');
      }

      // Função que gera um novo número e atualiza o gráfico
      function gerarEAtualizarDados(min, max) {
         const novoRegistro = Number(Math.random() * (max - min + 1) + min).toFixed(2);
         
         // Mantém apenas os últimos 10 pontos de dados
         if (dadosAtuais.length >= 10) {
            dadosAtuais.shift(); // Remove o primeiro elemento do array de dados
            graficoLinhaSensor.data.labels.shift(); // Remove o primeiro rótulo
         }
         
         dadosAtuais.push(novoRegistro); // Adiciona novo dado
         graficoLinhaSensor.data.labels.push(new Date().toLocaleTimeString()); // Adiciona rótulo de hora atual

         // Atualiza o gráfico na tela
         graficoLinhaSensor.update();
         console.log(`Dados Hectar: ${dadosAtuais}`);
      }

      var lista_registro = []
function buscarUltimosRegistros() {
      fetch(`/registros/buscarUltimosRegistros`, { cache: "no-store" }  )
         .then(resultado => resultado.json())
         .then(resultado => {
            console.log("Entrei listar")
            console.log(resultado)
         })

         .catch(function (erro) {
            console.log('Erro frontend', erro);
         })
   }

function listar() {
      var idusuario = sessionStorage.ID_USUARIO
      fetch(`/registros/listar`, { cache: "no-store" })
         .then(response => response.json())
         .then(function (response) {
            console.log("pedro", response);

            plotarGrafico(response);

         })
         .catch(function (error) {
            console.log(`Erro na obtenção dos dados p/ gráfico: ${error}`);
         });
      return false;
   }

function plotarGrafico(listaDados) {
  
   for (var i = 0; i < listaDados.length; i++) {
      var dado_atual = listaDados[i]
      var vida_atual = parseFloat(dado_atual.umidadeSolo) 
      
      lista_registro.push(vida_atual)

   }
   
   console.log('Array de valores para plotagem:', lista_registro); 
   
   console.log('iniciando plotagem do gráfico...');
   
   let labels = [];
   for (let i = 0; i < lista_registro.length; i++) {
      labels.push(`${i + 1}`);
   }

   let dados = {
      labels: labels,
      datasets: [{
         label: 'Umidade Hectar 1',
         data: lista_registro,
         borderColor: '#006838',
         tension: 0.1
      }]
   };

   const config = {
      type: 'line',
      data: dados,
   };


   let myChart = new Chart(
      document.getElementById(`graficoHectar1`),
      config
   );
   
   console.log('----------------------------------------------')
   console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
}

function HectarPrincipal() {
   document.getElementById('grafico_sensor').style.display = 'none';
   document.getElementById('grafico_h1').style.display = 'block';
}

buscarUltimosRegistros();
listar();

      // 

   </script>
</html>